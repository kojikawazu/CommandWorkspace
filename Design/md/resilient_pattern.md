# レジリエントパターン

システムの信頼性と耐障害性を高めるために使われる設計パターンです。特に、分散システムやマイクロサービスのような複雑な環境で、部分的な障害がシステム全体に波及しないようにするために重要です。

## レジリエントパターンの概要

レジリエントパターンは、システムが障害や負荷に対して回復力（レジリエンス）を持てるように設計するためのパターンで、一般的に以下のような技術が含まれます。

- サーキットブレーカー（Circuit Breaker）
  - サービスの呼び出しが失敗し続けると、一定の条件で呼び出しを遮断し、システム全体への影響を抑える仕組みです。
  - サービスが正常に戻った後に再度呼び出しを試みるため、回復も容易です。

- フォールバック（Fallback）
  - サービスが利用できない場合に、代替のレスポンスやデフォルトの処理を行います。
  - これにより、ユーザーに最低限の機能を提供し続けることができます。

- タイムアウト（Timeout）
  - サービス呼び出しが一定時間内に応答しない場合に強制的に終了させ、システム全体の遅延を回避します。
  - タイムアウトを適切に設定することで、リクエストが「ハング」するのを防ぎます。

- リトライ（Retry）
  - 呼び出しが失敗した場合、再試行することで一時的な障害に対応します。
  - リトライは慎重に実装する必要があり、無制限に再試行するのではなく、回数や間隔を設定して「指数バックオフ」を使うのが一般的です。

- レートリミット（Rate Limiting）
  - 特定のサービスに対して過剰なリクエストが送られないように制限をかける仕組みです。
  - サービスの過負荷を防ぎ、システム全体の安定性を確保します。

- バルクヘッド（Bulkhead）
  - サービス間のリソース（メモリやスレッド）を分離して、あるサービスの障害が他のサービスに波及しないようにする方法です。
  - これにより、部分的な障害が他の機能を巻き込むのを防ぎ、全体の信頼性を高めます。

## レジリエントパターンの具体例

たとえば、ECサイトで「注文サービス」「在庫サービス」「支払いサービス」が連携する場合、支払いサービスがダウンした時に備えて、以下のようにレジリエントパターンを適用します。

- サーキットブレーカー：
  - 支払いサービスの呼び出しに障害が一定回数続いた場合、サーキットブレーカーが発動し、新たな呼び出しを遮断します。数分後に再試行し、サービスが復旧すれば再開します。

- フォールバック：
  - 支払いサービスが利用できない時は「支払い処理中」として注文を一時的に保存し、ユーザーには後ほどの通知を約束するなどのフォールバックを行います。

- タイムアウト：
  - 支払いサービスが一定時間内に応答しない場合はタイムアウトを発動してキャンセルし、注文処理が滞らないようにします。

- リトライ：
  - 支払いが一時的に失敗した場合、指数バックオフを用いてリトライし、即座の障害対応を試みます。

- レートリミット：
  - 支払いサービスに対するリクエストが過剰にならないようにレートリミットを設定し、サービスの過負荷を防ぎます。

- バルクヘッド：
  - 支払い処理に割り当てるスレッドやメモリを他の機能から分離し、支払いサービスが過負荷でも注文サービスが安定するようにします。

## レジリエントパターンのメリット

- システムの安定性：障害が発生しても他の機能に影響を与えずに動作を維持できるため、システム全体の信頼性が向上します。

- ユーザー体験の向上：部分的な機能障害が発生しても、フォールバックやリトライによって最低限のサービスを提供し続けることが可能です。

- 負荷分散とリソース管理：リトライやレートリミットで負荷分散し、リソースを適切に管理できるため、予期しない負荷の増加にも耐えられます。

## レジリエントパターンのデメリット

- 複雑な設計と実装：各パターンの適用により、システムが複雑化し、設計や実装が難しくなることがあります。

- パフォーマンスへの影響：サーキットブレーカーやリトライによって一時的なオーバーヘッドが発生する場合があるため、適切なパラメータ設定が重要です。

- 管理の手間：サービスごとに適切なパターンを組み合わせるため、モニタリングやログ管理が重要で、運用負担が増えることがあります。

## レジリエントパターンの導入方法

レジリエントパターンは、障害が多い、または負荷の変動が激しいサービスから導入するのが効果的です。また、ツールやライブラリを活用して実装すると管理が簡単になります。
